---
import Layout from "../layouts/Layout.astro";
import { Button } from "../../@/components/ui/button";
import { Input } from "../../@/components/ui/input";
import { Label } from "../../@/components/ui/label";
import {
	Table,
	TableBody,
	TableCell,
	TableHead,
	TableHeader,
	TableRow,
} from "../../@/components/ui/table";
---

<Layout>
	<h1 class="text-3xl font-bold mb-4">Items</h1>
	<div class="mb-4">
		<Button id="openModalBtn">Add New Item</Button>
	</div>

	<div
		id="itemModal"
		class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden"
	>
		<div class="bg-white p-6 rounded-lg max-w-md w-full">
			<h2 class="text-2xl font-bold mb-4">Add New Item</h2>
			<form id="new-item-form" class="space-y-4">
				<div>
					<Label for="itemName">Item Name</Label>
					<Input type="text" id="itemName" name="name" required />
				</div>
				<div>
					<Label for="itemQuantity">Quantity</Label>
					<Input
						type="number"
						id="itemQuantity"
						name="quantity"
						required
						min="0"
					/>
				</div>
				<div>
					<Label for="itemDescription">Description</Label>
					<Input
						type="text"
						id="itemDescription"
						name="description"
					/>
				</div>
				<div class="flex justify-end space-x-2">
					<Button type="button" id="closeModalBtn" variant="outline"
						>Cancel</Button
					>
					<Button type="submit">Add Item</Button>
				</div>
			</form>
		</div>
	</div>

	<Table>
		<TableHeader>
			<TableRow>
				<TableHead>Name</TableHead>
				<TableHead>Quantity</TableHead>
				<TableHead>Description</TableHead>
				<TableHead>Actions</TableHead>
			</TableRow>
		</TableHeader>
		<TableBody id="itemsTableBody">
			<!-- Items will be loaded here -->
		</TableBody>
	</Table>
</Layout>

<script>
	import { fetchItems, createItem } from "../lib/api";

	const openModalBtn = document.getElementById("openModalBtn");
	const closeModalBtn = document.getElementById("closeModalBtn");
	const itemModal = document.getElementById("itemModal");
	const newItemForm = document.getElementById(
		"new-item-form",
	) as HTMLFormElement;
	const itemsTableBody = document.getElementById("itemsTableBody");

	openModalBtn.addEventListener("click", () => {
		itemModal.classList.remove("hidden");
	});

	closeModalBtn.addEventListener("click", () => {
		itemModal.classList.add("hidden");
	});

	itemModal.addEventListener("click", (e) => {
		if (e.target === itemModal) {
			itemModal.classList.add("hidden");
		}
	});

	newItemForm.addEventListener("submit", async (e) => {
		e.preventDefault();
		const formData = new FormData(newItemForm);
		const newItem = Object.fromEntries(formData.entries());

		try {
			await createItem(newItem);
			itemModal.classList.add("hidden");
			newItemForm.reset();
			await loadItems();
		} catch (error) {
			console.error("Error creating item:", error);
			// You might want to show an error message to the user here
		}
	});

	async function loadItems() {
		try {
			const items = await fetchItems();
			itemsTableBody.innerHTML = items
				.map(
					(item) => `
        <tr>
          <td>${item.name}</td>
          <td>${item.quantity}</td>
          <td>${item.description || "-"}</td>
          <td>
            <button class="text-blue-600 hover:text-blue-800">Edit</button>
            <button class="text-red-600 hover:text-red-800 ml-2">Delete</button>
          </td>
        </tr>
      `,
				)
				.join("");
		} catch (error) {
			console.error("Error loading items:", error);
			itemsTableBody.innerHTML =
				'<tr><td colspan="4">Error loading items</td></tr>';
		}
	}

	loadItems();
</script>
